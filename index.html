<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Extractor Datos Llantas PDF + OCR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
        h1 { text-align: center; }
        .container { text-align: center; padding: 30px; }
        .upload-area {
            border: 2px dashed #007bff;
            padding: 40px; margin: 20px auto; 
            max-width: 500px;
            cursor: pointer;
            border-radius: 10px;
            background: white;
        }
        .upload-area:hover {background: #e3f2fd;}
        input[type="file"] {display:none;}
        button {
            margin: 10px;
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-primary { background: #28a745; color: white; }
        .btn-primary:hover { background: #218838; }
        .btn-secondary { background: #dc3545; color: white; }
        .btn-secondary:hover { background: #c82333; }
        .btn-disabled { background: #6c757d; cursor: not-allowed; }
        #status {
            margin: 25px auto;
            padding: 15px;
            max-width: 600px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 18px;
            display: none;
        }
        .status-ready { background: #d4edda; color: #155724; }
        .status-processing { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-ocr { background: #d1ecf1; color: #0c5460; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th { background: #007bff; color: white; }
        .progress-container {
            display: none;
            max-width: 600px;
            margin: 20px auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }
        .progress-bar-bg {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #495057;
        }
        /* Modal para pedir el Nombre antes de enviar */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 420px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
        }
        .modal-actions { text-align: right; margin-top: 12px; }
        .modal-content h3 { margin: 0 0 8px 0; font-size: 18px; }
        .modal-content p { margin: 0 0 12px 0; color: #555; font-size: 14px; }
        #sheetNameInput { width: 100%; padding: 10px 12px; font-size: 15px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        /* Mejor apariencia para botones dentro del modal */
        .modal .btn-primary { background: #007bff; padding: 10px 14px; border-radius: 6px; }
        .modal .btn-secondary { background: #6c757d; padding: 10px 14px; border-radius: 6px; }
        /* Bot√≥n junto a INICIAR ESCANEO */
        #btnClearCache {
            position: static;
            display: inline-block;
            box-shadow: none;
            padding: 12px 18px;
            border-radius: 5px;
            margin-left: 8px;
            vertical-align: middle;
        }
        @media (max-width: 480px) {
            #btnClearCache { padding: 10px 14px; font-size: 14px; margin-left: 6px; display: inline-block; }
        }
    </style>
</head>
<body>
    <h1>Escanea tus traspasos para ser m√°s √°gil el proceso</h1>
    <div class="container">
        <div class="upload-area" onclick="document.getElementById('pdfInput').click()">
            <p>üìÅ Haz clic o arrastra aqu√≠ para seleccionar tu PDF</p>
            <input type="file" id="pdfInput" accept=".pdf" />
        </div>
        <button id="btnStart" class="btn-primary btn-disabled" onclick="startScan()" disabled>üöÄ INICIAR ESCANEO</button>
        <button id="btnClearCache" class="btn-secondary" onclick="confirmClearCache()" title="Limpiar cach√© y recargar" aria-label="Limpiar cach√©">üßπ LIMPIAR CACHE</button>
        <button id="btnClear" class="btn-secondary" onclick="clearAll()" style="display:none;">üóëÔ∏è LIMPIAR TODO</button>
    </div>
    <div id="status" class="status-ready">Esperando archivo PDF...</div>

    <div id="progressContainer" class="progress-container">
        <div class="progress-bar-bg">
            <div id="progressBar" class="progress-bar-fill"></div>
        </div>
        <div class="progress-text">
            <span id="progressText">0%</span> - <span id="pageCounter">P√°gina 0/0</span>
        </div>
    </div>

    <div id="result" style="display:none; max-width: 900px; margin: 20px auto; background:white; padding:10px; border-radius:10px;">
        <div style="text-align:center;">
            <button id="btnSendSheet" class="btn-primary" onclick="openNameModal()">üì§ ENVIAR A HOJA</button>
        </div>
        <div id="tableContainer"></div>
        <!-- Modal para pedir Nombre antes de enviar -->
        <div id="nameModal" class="modal">
            <div class="modal-content">
                <h3>Ingresa el nombre para la hoja</h3>
                <p>Este nombre se asignar√° a la columna <strong>traspasos/Nombre</strong> en la hoja.</p>
                <input id="sheetNameInput" type="text" placeholder="Nombre (ej. Sucursal A)" style="width:100%; padding:8px; font-size:16px;" />
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeNameModal()">Cancelar</button>
                    <button class="btn-primary" onclick="confirmSendToSheetDB()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script>
        const pdfInput = document.getElementById('pdfInput');
        const btnStart = document.getElementById('btnStart');
        const btnClear = document.getElementById('btnClear');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const tableContainer = document.getElementById('tableContainer');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const pageCounter = document.getElementById('pageCounter');
        let extractedData = [];
        let currentFile = null;

        pdfInput.addEventListener('change', () => {
            if(pdfInput.files.length > 0) {
                currentFile = pdfInput.files[0];
                enableStart();
                showStatus('‚úÖ Archivo PDF cargado. Listo para escanear.', 'status-ready');
            }
        });

        function enableStart() {
            btnStart.disabled = false;
            btnStart.classList.remove('btn-disabled');
        }

        function showStatus(message, statusClass) {
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = statusClass;
        }

        async function startScan() {
            if(!currentFile) {
                alert('‚ö†Ô∏è Por favor selecciona un archivo PDF primero.');
                return;
            }
            btnStart.disabled = true;
            btnStart.classList.add('btn-disabled');
            showStatus('üîÑ Escaneando PDF... por favor espera.', 'status-processing');
            progressContainer.style.display = 'block';

            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                const pdf = await pdfjsLib.getDocument({data: uint8Array.slice()}).promise;
                let rawText = '';

                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    rawText += content.items.map(item => item.str).join(' ') + '\n';
                    
                    // Actualizar barra de progreso
                    updateProgress(i, pdf.numPages);
                }

                // Detectar texto nativo para extraer directamente
                if(!textoTieneFormato(rawText)) {
                    showStatus('üì∏ PDF escaneado detectado. Iniciando OCR...', 'status-ocr');
                    console.log('‚ö†Ô∏è Activando OCR porque no se detect√≥ texto nativo');
                    extractedData = await ocrPDF(currentFile, pdf.numPages);
                    // marcar progreso completo despu√©s de OCR
                    completeProgress();
                } else {
                    console.log('‚úÖ Extrayendo de texto nativo (no OCR)');
                    extractedData = extraerProductos(rawText);
                    // marcar progreso completo despu√©s de extracci√≥n de texto
                    completeProgress();
                }

                if(extractedData.length === 0) {
                    showStatus('‚ö†Ô∏è No se encontraron productos. Verifica el PDF.', 'status-error');
                } else {
                    showStatus(`‚úÖ Escaneo completado. ${extractedData.length} productos extra√≠dos.`, 'status-ready');
                    displayTable();
                    btnClear.style.display = 'inline-block';
                }
                progressContainer.style.display = 'none';

            } catch(e) {
                console.error(e);
                showStatus('‚ùå Error procesando el PDF. Revisa el archivo y vuelve a intentarlo.', 'status-error');
                // Reset progress on error
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                pageCounter.textContent = '';
                progressContainer.style.display = 'none';
            }
            btnStart.disabled = false;
            btnStart.classList.remove('btn-disabled');
        }

        function updateProgress(current, total) {
            // Mostrar progreso parcial durante el procesamiento de p√°ginas.
            // Para evitar que la barra llegue a 100% antes de completar la extracci√≥n/OCR,
            // limitamos el progreso a 90% durante el loop de p√°ginas. El 100% se establece
            // expl√≠citamente cuando todo el procesamiento ha finalizado.
            const percentage = Math.round((current / total) * 90);
            progressBar.style.width = percentage + '%';
            progressText.textContent = percentage + '%';
            pageCounter.textContent = `P√°gina ${current}/${total}`;
        }

        function completeProgress() {
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
        }

        function textoTieneFormato(texto) {
            // Detecta si el PDF tiene texto extra√≠ble de alta calidad
            if(!texto || texto.length < 50) return false;
            
            // Buscar patrones de producto/art√≠culo
            const tieneEncabezados = /producto|art√≠culo|descripci√≥n|cantidad|c√≥digo/i.test(texto);
            
            // Buscar al menos una l√≠nea con formato de producto (n√∫mero + texto)
            const lineas = texto.split('\n');
            const tieneProductos = lineas.some(linea => {
                // Buscar l√≠neas que empiezan con n√∫mero seguido de m√°s datos
                return /^\d+\s+\S+\s+.+/i.test(linea.trim());
            });
            
            // Considerar que tiene buen formato si:
            // - Tiene encabezados Y al menos 1 producto, O
            // - Tiene muchas l√≠neas con formato de producto
            const conteoProductos = lineas.filter(l => /^\d+\s+\S+/.test(l.trim())).length;
            
            return (tieneEncabezados && tieneProductos) || conteoProductos >= 3;
        }

        function extraerProductos(texto) {
            const lineas = texto.split('\n');
            const productos = [];
            const productosSet = new Set(); // Para evitar duplicados exactos
            
            console.log('üìù Texto completo para extracci√≥n:', texto.substring(0, 500));
            console.log('üìä Total de l√≠neas a procesar:', lineas.length);
            
            // Palabras clave para filtrar l√≠neas innecesarias
            const palabrasExcluidas = ['producto', 'cantidad', 'c√≥digo', 'descripci√≥n', 'c√≥digo', 'total', 'subtotal', 
                                      'iva', 'neto', 'p√°gina', 'factura', 'invoice', 'referencia', 'unitario', 'precio',
                                      'articulo', 'item', 'importe', 'unit', 'fecha', 'empresa', 'nombre', 'encabezado'];
            
            for(let i = 0; i < lineas.length; i++) {
                let linea = lineas[i].trim();
                
                // Saltar l√≠neas vac√≠as o muy cortas
                if(!linea || linea.length < 2) continue;
                
                // Saltar l√≠neas que son SOLO palabras clave
                const esEncabezado = palabrasExcluidas.some(palabra => 
                    linea.toUpperCase() === palabra.toUpperCase() || 
                    linea.toUpperCase().startsWith(palabra.toUpperCase() + ' ') ||
                    linea.toUpperCase().endsWith(' ' + palabra.toUpperCase())
                );
                if(esEncabezado) continue;
                
                let match = null;
                let cantidad = null;
                let codigo = null;
                let descripcion = null;
                
                // Patr√≥n 1: "n√∫mero  c√≥digo  descripci√≥n" (espacios m√∫ltiples)
                match = linea.match(/^(\d+)\s{2,}([A-Z0-9\-]{2,})\s{2,}(.{2,})$/i);
                if(match) {
                    cantidad = parseInt(match[1], 10);
                    codigo = match[2].trim();
                    descripcion = match[3].trim();
                }
                
                // Patr√≥n 2: "n√∫mero c√≥digo descripci√≥n" (espacios normales, c√≥digo alfanum√©rico)
                if(!match) {
                    match = linea.match(/^(\d+)\s+([A-Z0-9\-\.]+)\s+(.{2,})$/i);
                    if(match) {
                        cantidad = parseInt(match[1], 10);
                        codigo = match[2].trim();
                        descripcion = match[3].trim();
                    }
                }
                
                // Patr√≥n 3: "n√∫mero  palabra  palabra  palabra" (muy flexible, c√≥digo = primera palabra)
                if(!match) {
                    match = linea.match(/^(\d+)\s+(\S+)\s+(.{2,})$/i);
                    if(match) {
                        cantidad = parseInt(match[1], 10);
                        codigo = match[2].trim();
                        descripcion = match[3].trim();
                    }
                }
                
                // Patr√≥n 4: L√≠nea con n√∫mero inicial (al menos 3 caracteres m√°s)
                if(!match && /^\d+\s/.test(linea) && linea.length > 5) {
                    match = linea.match(/^(\d+)\s+(.+)$/);
                    if(match && match[2].length >= 3) {
                        cantidad = parseInt(match[1], 10);
                        const resto = match[2].trim();
                        const palabras = resto.split(/\s+/);
                        
                        if(palabras.length >= 2) {
                            codigo = palabras[0];
                            descripcion = palabras.slice(1).join(' ');
                        } else if(palabras.length === 1 && resto.length > 3) {
                            codigo = resto.substring(0, Math.min(10, resto.length));
                            descripcion = resto;
                        }
                    }
                }
                
                // Validaciones MENOS estrictas
                if(cantidad !== null && codigo && descripcion) {
                    // Validar cantidad
                    if(isNaN(cantidad) || cantidad < 1 || cantidad > 999999) continue;
                    
                    // Validar c√≥digo (muy flexible ahora)
                    codigo = codigo.trim();
                    if(codigo.length < 1) continue;
                    if(/^[\d\s\-\.]+$/.test(codigo) && codigo.length < 3) continue; // Solo n√∫meros y separadores
                    
                    // Validar descripci√≥n
                    descripcion = descripcion.trim();
                    if(descripcion.length < 2) continue;
                    if(/^[\d\-\._\s]+$/.test(descripcion)) continue; // Solo n√∫meros y s√≠mbolos
                    
                    // Crear clave √∫nica para evitar duplicados exactos
                    const clave = `${cantidad}|${codigo}|${descripcion}`.toLowerCase();
                    if(productosSet.has(clave)) continue;
                    
                    console.log(`‚úÖ Producto encontrado: ${cantidad} | ${codigo} | ${descripcion}`);
                    
                    productos.push({
                        cantidad: cantidad,
                        codigo: codigo,
                        descripcion: descripcion
                    });
                    
                    productosSet.add(clave);
                }
            }
            
            console.log(`üì¶ Total productos EXTRA√çDOS: ${productos.length}`);
            return productos;
        }

        async function ocrPDF(file, numPages) {
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            const pdf = await pdfjsLib.getDocument({data: uint8Array}).promise;
            
            let allText = '';
            
            for(let i=1; i<=numPages; i++) {
                const page = await pdf.getPage(i);
                
                // Aumentar escala para mejor OCR
                const viewport = page.getViewport({scale: 3.0});
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({canvasContext: ctx, viewport}).promise;
                
                // Mejorar contraste del canvas antes de OCR
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Aplicar contraste para mejorar OCR
                for(let j = 0; j < data.length; j += 4) {
                    const avg = (data[j] + data[j+1] + data[j+2]) / 3;
                    const contrast = avg > 128 ? 255 : 0;
                    data[j] = contrast;
                    data[j+1] = contrast;
                    data[j+2] = contrast;
                }
                ctx.putImageData(imageData, 0, 0);
                
                const { data: { text } } = await Tesseract.recognize(canvas, 'spa');
                
                allText += text + '\n';
                
                // Actualizar barra de progreso durante OCR
                updateProgress(i, numPages);
            }
            
            console.log('üîç Texto OCR bruto (primeros 1000 caracteres):', allText.substring(0, 1000));
            
            // Limpiar el texto OCR para mejorar extracci√≥n - MENOS AGRESIVO
            // Mantener estructura de l√≠neas pero normalizar espacios
            allText = allText
                .split('\n')
                .map(linea => linea.trim())
                .filter(linea => linea.length > 0)
                .join('\n');
            
            console.log('üîç Texto OCR limpio (primeros 1000 caracteres):', allText.substring(0, 1000));
            
            // Extraer productos del texto OCR completo
            const datosPage = extraerProductos(allText);
            return datosPage;
        }

        function displayTable() {
            if(extractedData.length === 0) {
                console.warn('‚ö†Ô∏è No hay datos para mostrar. extractedData:', extractedData);
                return;
            }
            
            resultDiv.style.display = 'block';
            let totalCantidad = extractedData.reduce((acc, val) => acc + (val.cantidad || 0), 0);

            let html = `<h3>üìã ${extractedData.length} productos encontrados | Total unidades: ${totalCantidad}</h3>
                        <table>
                            <thead>
                                <tr><th>CANTIDAD</th><th>C√ìDIGO</th><th>DESCRIPCI√ìN</th></tr>
                            </thead>
                            <tbody>
                            ${extractedData.map((d, idx) => `
                                <tr>
                                    <td>${d.cantidad || 0}</td>
                                    <td>${d.codigo || 'N/A'}</td>
                                    <td>${d.descripcion || 'N/A'}</td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>`;
            
            tableContainer.innerHTML = html;
            console.log('‚úÖ Tabla mostrada. Datos:', extractedData);
        }

        function downloadCSV() {
            if(extractedData.length === 0) return;
            const csv = ['Cantidad,Codigo,Descripcion', ...extractedData.map(d =>
                `${d.cantidad},"${d.codigo}","${d.descripcion.replace(/"/g,'""')}"`
            )].join('\n');

            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `llantas_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }

        function copyTable() {
            if(extractedData.length === 0) return;
            const text = extractedData.map(d => `${d.cantidad}\t${d.codigo}\t${d.descripcion}`).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('¬°Tabla copiada al portapapeles!');
            });
        }

        // Modal control: abrir/cerrar
        function openNameModal() {
            const modal = document.getElementById('nameModal');
            const input = document.getElementById('sheetNameInput');
            let defaultName = '';
            if (currentFile && currentFile.name) {
                // Quitar extensi√≥n del archivo
                defaultName = currentFile.name.replace(/\.[^/.]+$/, '');
                // Eliminar caracteres no v√°lidos para nombres (/, \\, :, *, ?, ", <, >, |)
                defaultName = defaultName.replace(/[\/\\:\*\?"<>|]/g, '').trim();
            }
            input.value = defaultName || 'Traspasos';
            modal.style.display = 'flex';
            // Seleccionar todo para que el usuario pueda editar r√°pidamente
            setTimeout(() => { input.focus(); input.select(); }, 50);
        }

        function closeNameModal() {
            const modal = document.getElementById('nameModal');
            modal.style.display = 'none';
        }

        // Sanitizar texto antes de enviarlo a la base de datos
        // Permite: letras (incluye acentos), n√∫meros, espacios, par√©ntesis, gui√≥n, gui√≥n bajo, barra y punto
        // Incluye regla especial: corregir HUO1 ‚Üí HU01 en descripciones
        function sanitizeTextForDB(value) {
            if(value === null || value === undefined) return '';
            let cleaned = '';
            try {
                cleaned = String(value).replace(/[^\p{L}\p{N}\s()\-_/\.]/gu, '').trim();
            } catch (e) {
                // Si el entorno no soporta \p{L}/unicode, usar alternativa conservadora (letras latinas b√°sicas + n√∫meros)
                cleaned = String(value).replace(/[^A-Za-z0-9\s()\-_/\.]/g, '').trim();
            }
            // Regla especial: corregir HUO1 ‚Üí HU01 (letra + letra + letra + n√∫mero ‚Üí letra + letra + n√∫mero + letra)
            cleaned = cleaned.replace(/HUO(\d)/g, 'HU0$1');
            return cleaned;
        }

        // Confirmar y enviar a SheetDB
        async function confirmSendToSheetDB() {
            const input = document.getElementById('sheetNameInput');
            const rawNombre = (input.value || '').trim();
            const nombre = sanitizeTextForDB(rawNombre);
            if(!nombre) {
                alert('Por favor ingresa un nombre v√°lido (solo letras, n√∫meros y - _ / . ()).');
                input.focus();
                return;
            }
            closeNameModal();
            await sendToSheetDB(nombre);
        }

        async function sendToSheetDB(nombre) {
            if(!extractedData || extractedData.length === 0) {
                alert('No hay datos para enviar.');
                return;
            }

            // Construir filas: rellenar solo lo que tenemos, dem√°s como cadena vac√≠a
            // A√±adimos tanto 'traspasos/Nombre' como 'Nombre' por compatibilidad
            const safeNombre = sanitizeTextForDB(nombre);
            const rows = extractedData.map(item => ({
                'traspasos/Nombre': safeNombre,
                'Nombre': safeNombre,
                'Folio': '',
                'Fecha de Emisi√≥n': '',
                'Usuario': '',
                'Cantidad': item.cantidad != null ? String(item.cantidad) : '',
                'C√≥digo': sanitizeTextForDB(item.codigo || ''),
                'Descripci√≥n': sanitizeTextForDB(item.descripcion || '')
            }));

            try {
                showStatus('üîÑ Enviando datos a la hoja...','status-processing');

                // Enviar expl√≠citamente a la hoja llamada "traspasos"
                const res = await fetch('https://sheetdb.io/api/v1/mxhtunjhhyukj?sheet=traspasos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: rows })
                });

                if(!res.ok) {
                    const errText = await res.text();
                    console.error('SheetDB error:', res.status, errText);
                    showStatus('‚ùå Error al enviar: ' + res.status, 'status-error');
                    alert('Error al enviar los datos. Revisa la consola para m√°s detalles.');
                    return;
                }

                const json = await res.json();
                console.log('SheetDB response', json);
                showStatus('‚úÖ Datos enviados correctamente a la hoja "traspasos".', 'status-ready');
                alert('Datos enviados correctamente a la hoja "traspasos".');

                // Limpiar datos extra√≠dos y la interfaz tal como solicitaste
                extractedData = [];
                resultDiv.style.display = 'none';
                tableContainer.innerHTML = '';
                btnClear.style.display = 'none';
                pdfInput.value = '';
                // Deshabilitar bot√≥n de inicio hasta que se cargue otro PDF
                btnStart.disabled = true;
                if(!btnStart.classList.contains('btn-disabled')) btnStart.classList.add('btn-disabled');
                // Reset progreso visual
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                pageCounter.textContent = '';
                showStatus('Esperando archivo PDF...', 'status-ready');
            } catch (e) {
                console.error('Error al enviar a SheetDB', e);
                showStatus('‚ùå Error al enviar los datos.', 'status-error');
                alert('Ocurri√≥ un error al enviar los datos. Revisa la consola.');
            }
        }

        function confirmClearCache() {
            if (confirm('¬øDeseas borrar la cach√© y recargar la p√°gina?')) {
                clearCache();
            }
        }

        function confirmClearCache() {
            if (confirm('¬øDeseas borrar la cach√© y recargar la p√°gina?')) {
                clearCache();
            }
        }

        function clearCache() {
            try {
                // Limpiar localStorage y sessionStorage
                if (window.localStorage) localStorage.clear();
                if (window.sessionStorage) sessionStorage.clear();
            } catch (e) {
                console.warn('No se pudo limpiar storage:', e);
            }

            if ('caches' in window) {
                caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k))))
                    .then(() => {
                        showStatus('‚úÖ Cach√© y almacenamiento limpiados.', 'status-ready');
                        // Recargar para aplicar cambios
                        setTimeout(() => location.reload(), 600);
                    }).catch(err => {
                        console.error('Error limpiando Cache Storage:', err);
                        showStatus('‚ö†Ô∏è Error al limpiar la cach√©.', 'status-error');
                        alert('Ocurri√≥ un error al limpiar la cach√©. Revisa la consola.');
                    });
            } else {
                showStatus('‚úÖ Almacenamiento local limpiado.', 'status-ready');
                setTimeout(() => location.reload(), 600);
            }
        }

        function clearAll() {
            extractedData = [];
            pdfInput.value = '';
            resultDiv.style.display = 'none';
            tableContainer.innerHTML = '';
            btnClear.style.display = 'none';
            btnStart.disabled = true;
            btnStart.classList.add('btn-disabled');
            showStatus('Esperando archivo PDF...', 'status-ready');
        }
    </script>
</body>
</html>
