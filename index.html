<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>OCR directo desde PDF con pdf.js + Tesseract.js</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.15.349/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;          
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 40px;
    }
    h1 {
        color: #333;
        margin-bottom: 30px;
        text-align: center;
        font-size: 28px;
    }
    .input-section {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        align-items: center;
    }
    input[type="file"] {
        flex: 1;
        min-width: 200px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: border-color 0.3s;
    }
    input[type="file"]:hover {
        border-color: #667eea;
    }
    button {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    #procesBtn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        flex-shrink: 0;
    }
    #procesBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    #sendBtn {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        flex-shrink: 0;
        margin-top: 12px;
    }
    #sendBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
    }
    #sendBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    #status {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        font-size: 14px;
        color: #555;
        min-height: 40px;
        display: flex;
        align-items: center;
    }
    #status.success {
        border-left-color: #28a745;
        background: #d4edda;
        color: #155724;
    }
    #status.error {
        border-left-color: #dc3545;
        background: #f8d7da;
        color: #721c24;
    }
    #results {
        margin-top: 30px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
    }
    table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }
    table tbody tr:hover {
        background: #f8f9fa;
    }
    table tbody tr:last-child td {
        border-bottom: none;
    }
    table input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    /* Modal prompt for invoice name */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    .modal {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 420px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    .modal h3 { margin-bottom: 8px; font-size: 16px; }
    .modal input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 12px;
        font-size: 14px;
    }
    .modal .row { display:flex; gap:8px; justify-content:flex-end; }
    .modal .row button { min-width: 90px; }
</style>
</head>
<body>
<div class="container">
    <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 8px;">
        <button id="btnLimpiarDatos" style="padding:4px 10px;font-size:12px;background:#17a2b8;color:#fff;border-radius:4px;border:none;cursor:pointer;" title="Limpiar todos los datos de la p√°gina" onclick="limpiarDatosPagina()">
            üßΩ Limpiar datos
        </button>
        <button id="btnLimpiarCache" style="padding:4px 10px;font-size:12px;background:#ffc107;color:#333;border-radius:4px;border:none;cursor:pointer;" title="Limpiar cach√© local" onclick="limpiarCache()">
            üßπ Limpiar cach√©
        </button>
    </div>
    <h1>üìÑ Extraer datos de PDF con OCR y enviar a hoja</h1>
    
    <div class="input-section">
        <input type="file" id="pdfFile" accept="application/pdf" placeholder="Selecciona un archivo PDF..." />
        <button id="procesBtn" onclick="processPDF()">Procesar PDF</button>
    </div>

    <div id="status"></div>

    <div class="controls">
        <button id="sendBtn" onclick="sendToSheetDB()" disabled>üì§ Enviar seleccionados a hoja</button>
    </div>

    <div id="results"></div>

    <!-- Modal to request Nombre before sending -->
    <div id="nameModalBackdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true">
            <h3>Nombre para las filas</h3>
            <div>Ingresa el nombre que se asignar√° a la columna <strong>Nombre</strong> para todas las filas seleccionadas.</div>
            <input id="invoiceNameInput" type="text" placeholder="Nombre de la factura, cliente o pedido" />
            <div class="row">
                <button id="cancelNameBtn">Cancelar</button>
                <button id="confirmNameBtn">Enviar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Bot√≥n limpiar datos de la p√°gina
function limpiarDatosPagina() {
    if (!confirm('¬øSeguro que deseas limpiar todos los datos de la p√°gina?')) return;
    // Limpiar inputs de tipo file y texto
    document.querySelectorAll('input[type="file"]').forEach(inp => inp.value = '');
    document.querySelectorAll('input[type="text"], input[type="number"]').forEach(inp => inp.value = '');
    // Limpiar tablas y resultados
    const results = document.getElementById('results');
    if (results) results.innerHTML = '';
    const status = document.getElementById('status');
    if (status) status.textContent = '';
    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) sendBtn.disabled = true;
    // Limpiar selects y checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    // Si hay otros elementos de datos, agr√©galos aqu√≠
    // ...
}
// Bot√≥n limpiar cach√©
function limpiarCache() {
    if (confirm('¬øSeguro que deseas limpiar la cach√© local de este m√≥dulo?')) {
        try {
            localStorage.clear();
            sessionStorage.clear();
            alert('Cach√© local limpiada.');
        } catch (e) {
            alert('Error al limpiar cach√©: ' + e.message);
        }
    }
}
async function processPDF() {
    const fileInput = document.getElementById('pdfFile');
    const status = document.getElementById('status');
    status.textContent = "Cargando y procesando PDF... este proceso puede tardar varios segundos.";

    if (!fileInput.files.length) {
        alert("Selecciona un archivo PDF");
        return;
    }
    const file = fileInput.files[0];
    const arrayBuffer = await file.arrayBuffer();

    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    let fullText = "";

    for(let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({canvasContext: context, viewport: viewport}).promise;

        // OCR con Tesseract.js sobre la imagen canvas
        const { data: { text }} = await Tesseract.recognize(canvas, 'spa', { logger: m => {
            status.textContent = `Procesando p√°gina ${pageNum}/${pdf.numPages} - ${Math.round(m.progress*100)}%`;
        }});
        fullText += `\n--- P√°gina ${pageNum} ---\n` + text;
    }

    // Filtrar l√≠neas con cantidad, c√≥digo y descripci√≥n (ajustar regex seg√∫n formato)
    const lines = fullText.split('\n').map(l => l.trim()).filter(l => l);
    const regex = /^(\d+)\s+(\S+)\s+(.+)$/;

    const results = lines.map(line => {
        const match = regex.exec(line);
        if(match) {
            return {cantidad: match[1], codigo: match[2], descripcion: match[3]};
        }
        return null;
    }).filter(Boolean);

    if(results.length === 0) {
        status.textContent = "No se encontraron l√≠neas con el formato esperado.";
        return;
    }

    renderResults(results);
    status.textContent = `${results.length} l√≠nea(s) extra√≠da(s). Selecciona las que quieras y presiona 'Enviar seleccionados a hoja'.`;
}

// Renderiza una tabla con checkbox para seleccionar filas a enviar
function renderResults(results) {
    const container = document.getElementById('results');
    const sendBtn = document.getElementById('sendBtn');
    if (!results || results.length === 0) {
        container.innerHTML = '';
        sendBtn.disabled = true;
        return;
    }

    let html = '<table border="1" cellpadding="6" style="border-collapse:collapse; width:100%;">';
    html += '<thead><tr>' +
        '<th><input id="selectAll" type="checkbox" /></th>' +
        '<th>Cantidad</th>' +
        '<th>C√≥digo</th>' +
        '<th>Descripci√≥n</th>' +
        '</tr></thead><tbody>';

    results.forEach((r, i) => {
        html += `<tr>` +
            `<td><input class="rowCheck" data-idx="${i}" type="checkbox" /></td>` +
            `<td>${escapeHtml(r.cantidad)}</td>` +
            `<td>${escapeHtml(r.codigo)}</td>` +
            `<td>${escapeHtml(r.descripcion)}</td>` +
            `</tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
    sendBtn.disabled = false;

    // selectAll handler
    document.getElementById('selectAll').addEventListener('change', function(e) {
        const checks = container.querySelectorAll('.rowCheck');
        checks.forEach(c => c.checked = e.target.checked);
    });

    // individual check change -> enable/disable send button if none selected
    container.querySelectorAll('.rowCheck').forEach(chk => {
        chk.addEventListener('change', () => {
            const any = Array.from(container.querySelectorAll('.rowCheck')).some(c => c.checked);
            sendBtn.disabled = !any;
        });
    });
}

// Escapa texto para HTML simple
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
}

// Muestra modal para pedir el nombre y devuelve una promesa con el valor (o null si se cancela)
function promptForInvoiceName(defaultValue = '') {
    return new Promise((resolve) => {
        const backdrop = document.getElementById('nameModalBackdrop');
        const input = document.getElementById('invoiceNameInput');
        const confirmBtn = document.getElementById('confirmNameBtn');
        const cancelBtn = document.getElementById('cancelNameBtn');

        const keyHandler = (e) => {
            if (e.key === 'Enter') onConfirm();
            if (e.key === 'Escape') onCancel();
        };

        const cleanup = () => {
            backdrop.style.display = 'none';
            confirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
            input.removeEventListener('keydown', keyHandler);
        };

        const onConfirm = () => {
            const val = input.value.trim();
            cleanup();
            resolve(val);
        };
        const onCancel = () => {
            cleanup();
            resolve(null);
        };

        confirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', onCancel);
        input.addEventListener('keydown', keyHandler);

        input.value = defaultValue || '';
        backdrop.style.display = 'flex';
        input.focus();
    });
}

// Envia las filas seleccionadas a SheetDB
async function sendToSheetDB() {
    const container = document.getElementById('results');
    const status = document.getElementById('status');
    const checks = Array.from(container.querySelectorAll('.rowCheck')).filter(c => c.checked);
    if(checks.length === 0) {
        alert('Selecciona al menos una fila para enviar.');
        return;
    }

    // Pedir el nombre que se usar√° en la columna "Nombre"
    let nombre = await promptForInvoiceName();
    if (nombre === null) {
        status.textContent = 'Env√≠o cancelado por el usuario.';
        return;
    }
    // Si el usuario dej√≥ el nombre vac√≠o, pedirlo de nuevo hasta que escriba algo o cancele
    while (nombre !== null && nombre.trim() === '') {
        nombre = await promptForInvoiceName();
        if (nombre === null) {
            status.textContent = 'Env√≠o cancelado por el usuario.';
            return;
        }
    }

    // Reconstruir datos desde la tabla, asignando el mismo nombre a cada fila
    const rows = [];
    checks.forEach(c => {
        const tr = c.closest('tr');
        const tds = tr.querySelectorAll('td');
        // tds[1] = cantidad, tds[2] = codigo, tds[3] = descripcion
        const cantidad = tds[1].textContent.trim();
        const codigo = tds[2].textContent.trim();
        const descripcion = tds[3].textContent.trim();

        rows.push({
            "Nombre": nombre,
            "Folio": "",
            "Fecha de Emisi√≥n": "",
            "Usuario": "",
            "Cantidad": cantidad,
            "C√≥digo": codigo,
            "Descripci√≥n": descripcion
        });
    });

    // Mostrar en status y en consola el nombre que se va a usar
    status.textContent = `Enviando ${rows.length} fila(s) a la hoja con nombre: "${nombre}"...`;
    console.log('Nombre asignado a cada fila:', nombre);
    console.log('Rows to send:', rows);

    try {
        const endpoint = 'https://sheetdb.io/api/v1/c43nq1n4r4np3?sheet=traspasos';

        // Intento 1: formato { data: [ ... ] }
        console.log('SheetDB payload (attempt 1):', JSON.stringify({ data: rows }, null, 2));
        let resp = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: rows })
        });

        // Si devuelve 400, intentamos enviar solo el array (algunas APIs aceptan este formato)
        if (!resp.ok && resp.status === 400) {
            const txt = await resp.text();
            // mostrar respuesta del servidor para diagn√≥stico
            status.textContent = 'Error al enviar (formato {data:[]}): ' + resp.status + ' ' + txt + '\nIntentando formato alternativo...';

            console.log('SheetDB payload (attempt 2 - raw array):', JSON.stringify(rows, null, 2));
            resp = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rows)
            });
        }

        // Si a√∫n falla, intentamos enviar con claves 'sanitizadas' (sin '/', sin espacios, sin tildes)
        if (!resp.ok && resp.status === 400) {
            const sanitizeKey = k => k
                .normalize('NFD').replace(/\p{Diacritic}/gu, '') // quitar tildes
                .replace(/\//g, '_') // reemplazar '/' por '_'
                .replace(/\s+/g, '_') // espacios por '_'
                .replace(/[^\w_]/g, ''); // quitar otros caracteres

            const sanitizedRows = rows.map(r => {
                const nr = {};
                Object.keys(r).forEach(k => nr[sanitizeKey(k)] = r[k]);
                return nr;
            });

            console.log('SheetDB payload (attempt 3 - sanitized keys):', JSON.stringify({ data: sanitizedRows }, null, 2));
            resp = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: sanitizedRows })
            });
        }

        if(!resp.ok) {
            const txt = await resp.text();
            status.textContent = 'Error al enviar: ' + resp.status + ' ' + txt;
            status.className = 'error';
            console.error('SheetDB error response:', resp.status, txt);
            return;
        }

        // Intento exitoso
        let json;
        try { json = await resp.json(); } catch(e) { json = null; }
        status.textContent = '‚úì Env√≠o completo. ' + (json ? JSON.stringify(json) : 'OK');
        status.className = 'success';
        
        // Limpiar completamente para siguiente pedido
        container.innerHTML = '';
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('pdfFile').value = '';
        
        console.log('SheetDB success response:', json);
    } catch (err) {
        status.textContent = 'Excepci√≥n al enviar: ' + err.message;
        status.className = 'error';
        console.error(err);
    }
}
</script>
</body>
</html>
